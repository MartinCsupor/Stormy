<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <title>Stormy</title>
</head>
<body>
  <header class="flex flex-col">
    <section class="flex justify-between items-center lg:px-20">
      <a href="index.html" class="hover:opacity-50 h-auto w-50 ">

        <img src="images/logo.png" alt="Stormy logo" class="h-auto   hover:opacity-80 "  />
      
      </a>
        
      
      <h1 class="font-bold text-center text-4xl w-2/4 md:text-5xl lg:text-7xl mr-2 ">
        <a href="index.html" class="hover:opacity-80">
          Stormy
        </a>
      </h1>
      <div class="topnav">
        <button id="menuOpen" class="p-2 cursor-pointer">
          <img src="images/icons/hambuger-menu.svg" class="w-20 h-20 justify-center items-center " alt="Men√º" />
        </button>
        <div id="myLinks" class="menu">
          <button id="menuClose" class="close-btn">‚úï</button>
          <a href="index.html">F≈ëoldal</a>
          <a href="registeration.html">Regisztr√°ci√≥</a>
          <a href="login.html">Bejelentkez√©s</a>
        </div>
      </div>

      <a href="javascript:void(0);" class="icon"><i class="fa fa-bars"></i></a>

      <style>
        .topnav { position: relative; }
        .menu {
          position: fixed; top: 0; right: -100%; width: 70%; max-width: 300px; height: 100vh;
          background: #476D98; display: flex; flex-direction: column; padding: 2rem 1rem;
          transition: right 0.3s ease; z-index: 1000;
        }
        .menu.active { right: 0; }
        .menu a { color: white; text-decoration: none; padding: 1rem; font-size: 1.2rem; }
        .menu a:hover { background: rgba(255,255,255,0.2); border-radius: 8px; }
        .close-btn { align-self: flex-end; font-size: 2rem; color: white; background: none; border: none; cursor: pointer; margin-bottom: 1rem; }
      </style>
      <script>
        const menuOpen = document.getElementById('menuOpen');
        const menuClose = document.getElementById('menuClose');
        const menu = document.getElementById('myLinks');
        menuOpen?.addEventListener('click', () => menu.classList.add('active'));
        menuClose?.addEventListener('click', () => menu.classList.remove('active'));
      </script>
    </section>

        <section class="flex justify-between mx-2 py-5 items-center">
            <div>
                <input type="text" id="varosinput" placeholder="Keres√©s..." class="h-10 w-auto bg-[#476D98] rounded-lg px-2">
                <div id="talalatok" class="absolute mt-1 bg-[#82B3DB] rounded-md min-w-50"></div>
            </div>

            <div class="flex flex-row justify-evenly bg-[#82B3DB] rounded-full h-auto  py-1 gap-1 px-1 w-l">
                <div class="toggle-celsius bg-[#476D98] w-10 h-10 rounded-full flex justify-center items-center cursor-pointer" onclick="changeUnit('celsius')">
                    <p>¬∞C</p>
                </div>
                <div class="toggle-fahrenheit w-10 h-10 rounded-full flex justify-center items-center cursor-pointer" onclick="changeUnit('fahrenheit')">
                    <p>¬∞F</p>
                </div>
                
            </div>
        </section>
    </header>

    <main class="grid grid-cols-1 auto-rows-min lg:grid-cols-3">
        <section class="lg:col-start-1 lg:row-start-1">
            <div id="jelenlegi_idojaras" class="flex justify-between bg-[#476D98] p-4 rounded-lg m-2 h-auto h-[-webkit-fill-available]!">
                <!-- Jelenlegi id≈ëj√°r√°s -->
            </div>
        </section>

        <section class="lg:row-start-1 lg:col-start-2 lg:col-span-2">
            <div id="orankenti_idojaras" class="flex m-2 h-[-webkit-fill-available]!">
                <!-- √ìr√°nk√©nti id≈ëj√°r√°s -->
            </div>
        </section>

        <section class="lg:row-start-2 lg:col-start-2 lg:col-span-2">
            <div id="napi_idojaras" class="flex flex-col m-2 col-span-2 h-[-webkit-fill-available]!">
                <!-- Napi id≈ëj√°r√°s -->
            </div>
        </section>

        <section class="lg:row-start-2 lg:col-start-1 lg:row-span-2">
            <div id="idojaras_jellemzoi" class="flex flex-col justify-evenly m-2 p-2 rounded-lg bg-[#82B3DB] h-[-webkit-fill-available]!">
                <!-- Id≈ëj√°r√°s jellemz≈ëi -->
            </div>
        </section>

        <section class="lg:row-start-3 lg:col-start-2 lg:col-span-2">
            <div id="vitamin_ajanlo" class="w-auto bg-[#82B3DB] h-auto rounded-lg m-2 p-2 sm:p-4 flex flex-col justify-evenly h-[-webkit-fill-available]!">
               <!-- Vitamin aj√°nl√≥ -->
            </div>
        </section>
    </main>

  <div id="zene-ikon">
    <button id="music-toggle" class="fixed bottom-4 right-4 bg-[#8CD9FF] p-3 rounded-full shadow-lg hover:bg-[#2F8BB7]">
      <img src="images/icons/zene icon.svg" class="w-8 h-8" />
    </button>
  </div>

  <!-- Music Panel -->
  <div id="music-panel" class="hidden fixed bottom-24 right-4 bg-[#476D98] rounded-2xl p-6 w-80 z-50">
    <div class="flex justify-between items-center mb-4">
      <div class="flex items-center">
        <div class="w-12 h-12 bg-gray-300 rounded-md"></div>
        <div class="ml-4">
          <p id="song-title" class="text-lg font-bold">Zene c√≠me</p>
          <p id="song-artist" class="text-sm">El≈ëad√≥ neve</p>
        </div>
      </div>
      <button id="close-music" class="w-5 h-5"><img src="images/icons/close icon.svg" /></button>
    </div>

    <div class="mt-3">
      <label for="mood-filter" class="block text-sm mb-1">Hangulat / Id≈ëj√°r√°s</label>
      <select id="mood-filter" class="w-full p-2 rounded bg-[#5A7BAA] text-white">
        <option value="" selected>V√°lassz hangulatot‚Ä¶</option>
        <option value="clear">Napos</option>
        <option value="clouds">Bor√∫s</option>
        <option value="rain">Es≈ës</option>
        <option value="thunder">Viharos</option>
        <option value="snow">Havas</option>
        <option value="mist">K√∂d√∂s</option>
        <option value="wind">Szeles</option>
      </select>
    </div>

    <div class="mt-2 px-1">
      <input id="progress-bar" type="range" min="0" max="100" value="0" class="w-full h-1 bg-[#5A7BAA] rounded-lg appearance-none cursor-pointer accent-[#8CD9FF]">
      <div class="flex justify-between text-xs text-white mt-1">
        <span id="current-time">0:00</span>
        <span id="duration">0:00</span>
      </div>
    </div>

    <div class="flex justify-between items-center text-xl mt-3">
      <button id="prev"><img src="images/icons/prev.svg" class="w-7 h-7" alt="Previous"></button>
      <button id="play-pause"><img src="images/icons/play.svg" class="w-7 h-7" alt="Play/Pause"></button>
      <button id="next"><img src="images/icons/next.svg" class="w-6 h-6" alt="Next"></button>
      <button id="recommend-music" title="Zeneaj√°nl√≥ (id≈ëj√°r√°s alapj√°n)">üéµ</button>
      <button id="open-add-music" title="Zene hozz√°ad√°sa">‚ûï</button>
      <button id="toggle-favorite" title="Kedvencek k√∂z√© / onnan ki">ü§ç</button>
      <button id="delete-track" title="Jelenlegi zene t√∂rl√©se">üóë</button>
    </div>
    <div class="flex justify-between items-center text-sm mt-2">
      <button id="toggle-favorites-only" class="px-2 py-1 rounded bg-[#5A7BAA] text-white" title="Csak kedvencek megjelen√≠t√©se">Csak kedvencek: KI</button>
    </div>
  </div>

  <!-- Add Music Modal -->
  <div id="add-music-modal" class="hidden fixed bottom-24 right-96 bg-[#82B3DB] rounded-2xl p-6 w-80 z-50">
    <h2 class="text-lg font-bold mb-4 text-center">Egy√©ni zene hozz√°ad√°sa</h2>
    <input id="music-url" type="text" placeholder="Zene URL (YouTube, SoundCloud vagy MP3)" class="w-full mb-3 p-2 rounded bg-[#5A7BAA] text-white" />
    <input id="music-title" type="text" placeholder="Zene c√≠me" class="w-full mb-2 p-2 rounded bg-[#5A7BAA] text-white" />
    <label for="music-mood" class="block text-sm mb-1">Hangulat / Id≈ëj√°r√°s</label>
    <select id="music-mood" class="w-full mb-4 p-2 rounded bg-[#5A7BAA] text-white">
      <option value="">(opcion√°lis)</option>
      <option value="clear">Napos</option>
      <option value="clouds">Bor√∫s</option>
      <option value="rain">Es≈ës</option>
      <option value="thunder">Viharos</option>
      <option value="snow">Havas</option>
      <option value="mist">K√∂d√∂s</option>
      <option value="wind">Szeles</option>
      <option value="chill">Laza</option>
    </select>
    <div class="flex justify-between">
      <button id="cancel-music" class="bg-[#476D98] px-4 py-2 rounded">M√©gse</button>
      <button id="add-music" class="bg-[#476D98] px-4 py-2 rounded">Hozz√°ad√°s</button>
    </div>
  </div>

  <!-- Players -->
  <audio id="audio-player"></audio>
  <div style="position:fixed; bottom:0; left:0; width:320px; height:180px; opacity:0.1; pointer-events:none;" class="hidden"><div id="yt-player"></div></div>
  <div style="position:fixed; bottom:0; left:330px; width:320px; height:180px; opacity:0.1; pointer-events:none;" class="hidden"><iframe id="sc-player" allow="autoplay"></iframe></div>

  <script src="https://w.soundcloud.com/player/api.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // UI
      const musicToggle = document.getElementById('music-toggle');
      const musicPanel = document.getElementById('music-panel');
      const addMusicModal = document.getElementById('add-music-modal');
      const cancelMusicBtn = document.getElementById('cancel-music');
      const closeMusicBtn = document.getElementById('close-music');
      const openAddBtn = document.getElementById('open-add-music');

      musicToggle?.addEventListener('click', () => musicPanel.classList.toggle('hidden'));
      cancelMusicBtn?.addEventListener('click', () => addMusicModal.classList.add('hidden'));
      closeMusicBtn?.addEventListener('click', () => { musicPanel.classList.add('hidden'); addMusicModal.classList.add('hidden'); });
      openAddBtn?.addEventListener('click', () => addMusicModal.classList.toggle('hidden'));

      // Elements
      const audio = document.getElementById('audio-player');
      audio.volume = 0.8;
      const playPauseBtn = document.getElementById('play-pause');
      const prevBtn = document.getElementById('prev');
      const nextBtn = document.getElementById('next');
      const addBtn = document.getElementById('add-music');
      const recommendBtn = document.getElementById('recommend-music');

      const urlInput = document.getElementById('music-url');
      const titleInput = document.getElementById('music-title');
      const moodInput = document.getElementById('music-mood');

      const titleText = document.getElementById('song-title');
      const artistText = document.getElementById('song-artist');
      const moodSelect = document.getElementById('mood-filter');
      const favBtn = document.getElementById('toggle-favorite');
      const delBtn = document.getElementById('delete-track');
      const favOnlyBtn = document.getElementById('toggle-favorites-only');
      const scIframe = document.getElementById('sc-player');
      let scWidget = null;
      
      const progressBar = document.getElementById('progress-bar');
      const currentTimeEl = document.getElementById('current-time');
      const durationEl = document.getElementById('duration');

      // State
      let playlist = [];
      let currentIndex = 0;
      let isPlaying = false;
      let mode = null; // 'audio' | 'youtube' | 'soundcloud'

      let favorites = new Set();
      let favoritesOnly = false;
      let fullPlaylistBackup = null;

      let library = [];
      let moodFilter = null;
      let moodPlaylistBackup = null;
      let isDraggingProgress = false;
      let scDuration = 0;

      // Helpers
      function getTrackKey(track) {
        if (!track) return '';
        if (track.type === 'youtube') return `youtube:${track.id}`;
        if (track.type === 'soundcloud') return `soundcloud:${track.url}`;
        return `audio:${track.url}`;
      }
      function loadFavorites() {
        try { const arr = JSON.parse(localStorage.getItem('stormy_favorites') || '[]'); favorites = new Set(Array.isArray(arr) ? arr : []); }
        catch { favorites = new Set(); }
      }
      function saveFavorites() {
        try { localStorage.setItem('stormy_favorites', JSON.stringify(Array.from(favorites))); } catch {}
      }
      function isFavorite(track) { return favorites.has(getTrackKey(track)); }
      function updateFavoriteButton() {
        const song = playlist[currentIndex];
        favBtn.textContent = song && isFavorite(song) ? '‚ù§Ô∏è' : 'ü§ç';
      }
      function loadLibrary() {
        try { const arr = JSON.parse(localStorage.getItem('stormy_library') || '[]'); library = Array.isArray(arr) ? arr : []; }
        catch { library = []; }
      }
      function saveLibrary() { try { localStorage.setItem('stormy_library', JSON.stringify(library)); } catch {} }

      // Recommendations
      const RECOMMENDATIONS = {
        clear: [
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3', title: 'Napos Chill 1' },
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-12.mp3', title: 'Napos Chill 2' },
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3', title: 'Napos Vibe' },
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-9.mp3', title: 'Naps√ºt√©s Dallam' },
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-10.mp3', title: 'Ny√°ri Szell≈ë' }
        ],
        clouds: [
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3', title: 'Bor√∫s Hangulat 1' },
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-13.mp3', title: 'Bor√∫s Hangulat 2' },
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-11.mp3', title: 'Felh≈ëk Felett' },
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-15.mp3', title: 'Sz√ºrke √âgbolt' },
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-16.mp3', title: 'M√©lab√∫s Ritmus' }
        ],
        rain: [
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3', title: 'Es≈ës Nap 1' },
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-14.mp3', title: 'Es≈ës Nap 2' },
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3', title: 'Cseppek T√°nca' },
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-6.mp3', title: 'Ablakp√°rk√°ny Blues' },
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-7.mp3', title: 'Vizes Aszfalt' }
        ],
        thunder: [
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3', title: 'Viharos Energia' },
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3', title: 'Vill√°ml√°s Rock' },
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3', title: 'D√∂rg≈ë Basszus' },
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-11.mp3', title: '√âgi H√°bor√∫' },
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-13.mp3', title: 'Adrenalin Vihar' }
        ],
        snow: [
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3', title: 'T√©li Nyugalom' },
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3', title: 'H√≥pelyhek T√°nca' },
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-9.mp3', title: 'Fagyos Csend' },
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-10.mp3', title: 'Kandall√≥ Mellett' },
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-16.mp3', title: 'Decemberi √âj' }
        ],
        mist: [
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-6.mp3', title: 'K√∂d√∂s Hangulat' },
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3', title: 'P√°r√°s Reggel' },
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-7.mp3', title: 'Elveszve a K√∂dben' },
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-14.mp3', title: 'Misztikus Dallam' },
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-15.mp3', title: 'Hom√°lyos Horizont' }
        ],
        wind: [
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-7.mp3', title: 'Szeles Flow' },
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3', title: 'S√ºv√≠t≈ë Sz√©l' },
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3', title: 'Rep√ºl≈ë Levelek' },
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-10.mp3', title: 'Szabads√°g Dala' },
          { type: 'audio', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-12.mp3', title: 'Viharos Fuvallat' }
        ]
      };

      function getCurrentMood() {
        const t = (document.getElementById('jelenglegi_idojaras_ikon_leiras')?.textContent || '').toLowerCase();
        if (t.includes('tiszta') || t.includes('der√ºlt')) return 'clear';
        if (t.includes('felh≈ë') || t.includes('bor√∫s')) return 'clouds';
        if (t.includes('es≈ë') || t.includes('z√°por') || t.includes('szit√°l')) return 'rain';
        if (t.includes('zivatar') || t.includes('vihar')) return 'thunder';
        if (t.includes('h√≥')) return 'snow';
        if (t.includes('k√∂d') || t.includes('p√°ra') || t.includes('szmog') || t.includes('hamu')) return 'mist';
        if (t.includes('sz√©l') || t.includes('viharos')) return 'wind';
        return 'clear';
      }
      function recommendByWeather() {
        const mood = getCurrentMood();
        const list = RECOMMENDATIONS[mood] || [];
        playlist = list.map(item => item.type === 'youtube' ? { type: 'youtube', id: item.id, title: item.title } : { type: 'audio', url: item.url, title: item.title });
        try { localStorage.setItem('stormy_playlist', JSON.stringify(playlist)); } catch {}
        currentIndex = 0;
        if (playlist.length) loadSong(0, true); else { titleText.textContent = 'Nincs dal'; artistText.textContent = ''; audio.src=''; updateFavoriteButton(); }
      }

      // Mood filter
      function applyMoodFilter(mood) {
        if (!mood) {
          moodFilter = null;
          if (moodPlaylistBackup) { playlist = moodPlaylistBackup.slice(); moodPlaylistBackup = null; }
          currentIndex = 0;
          if (playlist.length) loadSong(0, false); else { titleText.textContent = 'Nincs dal'; artistText.textContent=''; try { audio.pause(); } catch {}; audio.src=''; updateFavoriteButton(); }
          try { localStorage.setItem('stormy_playlist', JSON.stringify(playlist)); } catch {}
          return;
        }
        if (!moodPlaylistBackup) moodPlaylistBackup = playlist.slice();
        moodFilter = mood;
        let filtered = library.filter(t => (t.mood || '') === mood);
        if (favoritesOnly) filtered = filtered.filter(t => isFavorite(t));
        playlist = filtered;
        currentIndex = 0;
        if (playlist.length) loadSong(0, false); else { titleText.textContent = 'Nincs dal'; artistText.textContent=''; try { audio.pause(); } catch {}; audio.src=''; updateFavoriteButton(); }
        try { localStorage.setItem('stormy_playlist', JSON.stringify(playlist)); } catch {}
      }

      // Players
      let ytPlayer = null; let pendingVideoId = null; let ytPlayRetryTimer = null; let ytPendingPlay = false;
      function extractVideoId(url) {
        try {
          const u = new URL(url);
          if (u.searchParams.get('v')) return u.searchParams.get('v');
          const parts = u.pathname.split('/').filter(Boolean);
          if (u.hostname.includes('youtu.be')) return parts[0] || null;
          const iS = parts.indexOf('shorts'); if (iS !== -1) return parts[iS+1] || null;
          const iE = parts.indexOf('embed'); if (iE !== -1) return parts[iE+1] || null;
        } catch(e) { const m = url.match(/(?:v=|youtu\.be\/|shorts\/|embed\/)([A-Za-z0-9_-]{6,})/); if (m) return m[1]; }
        return null;
      }
      window.onYouTubeIframeAPIReady = () => {
        ytPlayer = new YT.Player('yt-player', {
          height: '180', width: '320', playerVars: { controls: 1 },
          events: {
            onReady: () => { try { ytPlayer.unMute(); ytPlayer.setVolume(80); } catch {} if (pendingVideoId) { ytPlayer.cueVideoById(pendingVideoId); pendingVideoId = null; } if (ytPendingPlay) { ytPendingPlay = false; try { ytPlayer.playVideo(); } catch {} } },
            onStateChange: (e) => {
              if (e.data === YT.PlayerState.PLAYING) { isPlaying = true; playPauseBtn.querySelector('img').src = 'images/icons/pause.svg'; }
              else if (e.data === YT.PlayerState.PAUSED || e.data === YT.PlayerState.CUED) { isPlaying = false; playPauseBtn.querySelector('img').src = 'images/icons/play.svg'; }
              else if (e.data === YT.PlayerState.ENDED) { nextBtn?.click(); }
            }
          }
        });
      };

      // Progress Helpers
      const formatTime = (s) => {
        if (!s || isNaN(s) || !isFinite(s)) return "0:00";
        const m = Math.floor(s / 60);
        const sec = Math.floor(s % 60);
        return `${m}:${sec < 10 ? '0' : ''}${sec}`;
      };

      function loadSong(index, autoPlay = false) {
        const song = playlist[index]; if (!song) return;
        isPlaying = false; playPauseBtn.querySelector('img').src = 'images/icons/play.svg';
        titleText.textContent = song.title; artistText.textContent = 'Felhaszn√°l√≥'; updateFavoriteButton();
        if (song.type === 'soundcloud') {
          mode = 'soundcloud'; try { ytPlayer?.pauseVideo?.(); } catch {}; try { audio.pause(); } catch {}; audio.src = '';
          const playerUrl = `https://w.soundcloud.com/player/?url=${encodeURIComponent(song.url)}&auto_play=${autoPlay ? 'true' : 'false'}`;
          if (scIframe) {
            scIframe.src = playerUrl;
            if (!scWidget && window.SC && window.SC.Widget) {
              scWidget = SC.Widget(scIframe);
              try {
                scWidget.bind(SC.Widget.Events.PLAY, () => { isPlaying = true; playPauseBtn.querySelector('img').src = 'images/icons/pause.svg'; });
                scWidget.bind(SC.Widget.Events.PAUSE, () => { isPlaying = false; playPauseBtn.querySelector('img').src = 'images/icons/play.svg'; });
                scWidget.bind(SC.Widget.Events.FINISH, () => { nextBtn?.click(); });
                scWidget.bind(SC.Widget.Events.PLAY_PROGRESS, (data) => {
                  if (mode !== 'soundcloud' || isDraggingProgress) return;
                  // data.currentPosition is ms, relativePosition is 0-1
                  if (scDuration) { progressBar.value = data.relativePosition * 100; currentTimeEl.textContent = formatTime(data.currentPosition / 1000); durationEl.textContent = formatTime(scDuration / 1000); }
                });
                scWidget.bind(SC.Widget.Events.READY, () => { scWidget.getDuration(d => { scDuration = d; durationEl.textContent = formatTime(d / 1000); }); });
              } catch {}
            }
            if (scWidget && scWidget.load) { try { scWidget.load(song.url, { auto_play: autoPlay, show_comments: false, visual: false }); } catch {} }
          }
        } else if (song.type === 'youtube') {
          mode = 'youtube'; try { audio.pause(); } catch {}; audio.src = '';
          if (ytPlayer && typeof ytPlayer.loadVideoById === 'function') {
            ytPlayer.loadVideoById(song.id);
            if (autoPlay) { try { ytPlayer.unMute(); ytPlayer.setVolume(80); ytPlayer.playVideo(); } catch {} }
          } else { pendingVideoId = song.id; if (autoPlay) ytPendingPlay = true; }
        } else {
          mode = 'audio'; try { ytPlayer?.pauseVideo?.(); } catch {};
          audio.src = song.url; if (autoPlay) audio.play().catch(() => {});
        }
      }

      // Progress Bar Events
      progressBar?.addEventListener('input', () => { isDraggingProgress = true; });
      progressBar?.addEventListener('change', () => {
        isDraggingProgress = false;
        const percent = parseFloat(progressBar.value);
        if (mode === 'audio') {
          if (audio.duration) audio.currentTime = (percent / 100) * audio.duration;
        } else if (mode === 'youtube' && ytPlayer && ytPlayer.seekTo) {
          const dur = ytPlayer.getDuration();
          if (dur) ytPlayer.seekTo((percent / 100) * dur, true);
        } else if (mode === 'soundcloud' && scWidget) {
          if (scDuration) scWidget.seekTo((percent / 100) * scDuration);
        }
      });
      // YouTube Progress Polling
      setInterval(() => {
        if (mode === 'youtube' && isPlaying && !isDraggingProgress && ytPlayer && ytPlayer.getCurrentTime) {
          const curr = ytPlayer.getCurrentTime();
          const dur = ytPlayer.getDuration();
          if (dur) { progressBar.value = (curr / dur) * 100; currentTimeEl.textContent = formatTime(curr); durationEl.textContent = formatTime(dur); }
        }
      }, 500);

      // Controls
      playPauseBtn.addEventListener('click', () => {
        if (!playlist.length) return;
        if (!isPlaying) {
          if (mode === 'youtube') {
            const tryNow = () => { if (ytPlayer && typeof ytPlayer.playVideo === 'function') { try { ytPlayer.unMute(); ytPlayer.setVolume(80); } catch {}; ytPlayer.playVideo(); return true; } return false; };
            if (!tryNow()) { ytPendingPlay = true; clearTimeout(ytPlayRetryTimer); ytPlayRetryTimer = setTimeout(() => { if (!tryNow()) { ytPlayRetryTimer = setTimeout(() => { tryNow(); }, 700); } }, 300); }
          } else if (mode === 'soundcloud') { try { scWidget && scWidget.play && scWidget.play(); } catch {} }
          else { audio.play(); }
        } else {
          if (mode === 'youtube') { try { ytPlayer?.pauseVideo?.(); } catch {} }
          else if (mode === 'soundcloud') { try { scWidget && scWidget.pause && scWidget.pause(); } catch {} }
          else { audio.pause(); }
        }
      });
      nextBtn?.addEventListener('click', () => { if (!playlist.length) return; currentIndex = (currentIndex + 1) % playlist.length; loadSong(currentIndex, true); });
      prevBtn?.addEventListener('click', () => { if (!playlist.length) return; currentIndex = (currentIndex - 1 + playlist.length) % playlist.length; loadSong(currentIndex, true); });

      favBtn?.addEventListener('click', () => { const song = playlist[currentIndex]; if (!song) return; const key = getTrackKey(song); if (favorites.has(key)) favorites.delete(key); else favorites.add(key); saveFavorites(); updateFavoriteButton(); });

      delBtn?.addEventListener('click', () => {
        if (!playlist.length) return;
        try { ytPlayer?.pauseVideo?.(); } catch {}; try { scWidget && scWidget.pause && scWidget.pause(); } catch {}; try { audio.pause(); } catch {};
        const removed = playlist.splice(currentIndex, 1)[0];
        try { localStorage.setItem('stormy_playlist', JSON.stringify(playlist)); } catch {};
        if (removed) { const rKey = getTrackKey(removed); const before = library.length; library = library.filter(t => getTrackKey(t) !== rKey); if (library.length !== before) saveLibrary(); }
        if (fullPlaylistBackup) { const key = getTrackKey(removed); fullPlaylistBackup = fullPlaylistBackup.filter(t => getTrackKey(t) !== key); }
        if (!playlist.length) { currentIndex = 0; titleText.textContent = 'Nincs dal'; artistText.textContent = ''; audio.src = ''; updateFavoriteButton(); return; }
        if (currentIndex >= playlist.length) currentIndex = 0; loadSong(currentIndex);
      });

      favOnlyBtn?.addEventListener('click', () => {
        favoritesOnly = !favoritesOnly;
        if (favoritesOnly) { fullPlaylistBackup = playlist.slice(); playlist = fullPlaylistBackup.filter(t => isFavorite(t)); currentIndex = 0; favOnlyBtn.textContent = 'Csak kedvencek: BE'; }
        else { if (fullPlaylistBackup) playlist = fullPlaylistBackup; fullPlaylistBackup = null; currentIndex = 0; favOnlyBtn.textContent = 'Csak kedvencek: KI'; }
        if (playlist.length) loadSong(0); else { titleText.textContent = 'Nincs dal'; artistText.textContent=''; audio.src=''; updateFavoriteButton(); }
      });

      audio.addEventListener('play', () => { isPlaying = true; playPauseBtn.querySelector('img').src = 'images/icons/pause.svg'; });
      audio.addEventListener('pause', () => { isPlaying = false; playPauseBtn.querySelector('img').src = 'images/icons/play.svg'; });
      audio.addEventListener('ended', () => { nextBtn?.click(); });
      audio.addEventListener('timeupdate', () => {
        if (mode === 'audio' && !isDraggingProgress && audio.duration) { progressBar.value = (audio.currentTime / audio.duration) * 100; currentTimeEl.textContent = formatTime(audio.currentTime); durationEl.textContent = formatTime(audio.duration); }
      });
      audio.addEventListener('loadedmetadata', () => { if (mode === 'audio') durationEl.textContent = formatTime(audio.duration); });

      // Add Music
      addBtn?.addEventListener('click', () => {
        const url = urlInput.value.trim(); const title = titleInput.value.trim(); const moodVal = (moodInput?.value || '').trim();
        if (!url || !title) { alert('T√∂lts ki mindent!'); return; }
        let newTrack = null;
        if (/(youtube\.com|youtu\.be)/i.test(url)) { const videoId = extractVideoId(url); if (!videoId) { alert('√ârv√©nyes YouTube link kell!'); return; } newTrack = { type: 'youtube', id: videoId, title, mood: moodVal || undefined }; }
        else if (/(soundcloud\.com)/i.test(url)) { newTrack = { type: 'soundcloud', url, title, mood: moodVal || undefined }; }
        else { newTrack = { type: 'audio', url, title, mood: moodVal || undefined }; }
        library.push(newTrack); saveLibrary();
        if (moodFilter) { applyMoodFilter(moodFilter); } else {
          playlist.push(newTrack); try { localStorage.setItem('stormy_playlist', JSON.stringify(playlist)); } catch {};
          if (playlist.length === 1) { currentIndex = 0; loadSong(0, false); }
        }
        urlInput.value = ''; titleInput.value = ''; if (moodInput) moodInput.value = '';
        addMusicModal.classList.add('hidden'); alert('Zene hozz√°adva!');
      });

      // Weather-based recommend
      recommendBtn?.addEventListener('click', () => { recommendByWeather(); });

      // Mood select filter
      moodSelect?.addEventListener('change', (e) => { const val = (e.target.value || '').trim(); applyMoodFilter(val || null); });

      // Init
      loadFavorites(); loadLibrary();
      try { const saved = JSON.parse(localStorage.getItem('stormy_playlist') || '[]'); if (Array.isArray(saved) && saved.length) { playlist = saved; loadSong(0, false); } else { updateFavoriteButton(); } } catch { updateFavoriteButton(); }
    });
  </script>

  <script src="index.js"></script>
</body>
</html>
